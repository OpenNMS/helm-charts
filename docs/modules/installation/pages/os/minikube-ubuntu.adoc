
This section describes how to install `kubectl/minikube/helm` on Debian 11.6.

. If virtualized, make sure virtual CPU extensions are passed through to `guest`/
+
IMPORTANT: With Debian, if your host system is configured for DHCP, be aware that an automatic entry in /etc/hosts with the hostname resolving to `127.0.1.1` is created.
This might cause some things to fail if that IP address isn't expected to resolve this hostname; for example, DHCP MAC address reservation to assign a specific IP address.
For more information, see https://www.debian.org/doc/manuals/debian-reference/ch05.en.html#_the_hostname_resolution[the hostname resolution] in the Debian documentation.

. Configure your user account to be a `sudoer`.
. Log on as root and run the following `usermod -aG sudo youraccount`.
. Logoff or reboot for the change to take effect.
. Install curl
+
`sudo apt install curl`

. Install vim, unless you can only handle vi.
+
`sudo apt install vim`

. Externally configure PostgreSQL, if not using containerized PostgreSQL.
+
[source, console]
----
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/pgdg.gpg
sudo apt update
sudo apt install postgresql-15
----

. In `/etc/postgresql/##/main`, reconfigure `pg_hba.conf` to allow external access to `192.168.0.0/24` and change `postgresql.conf` to listen on all interfaces.

. Follow doc instructions to install database.
.. Database name needs to be `<instance name>_opennms` and not just `opennms`, where `<instance name>`` is the name of the pod.

. Sett up and install `kubectl`:
+
[source, console]
----
sudo apt install -y ca-certificates
sudo curl -fsSLo /etc/apt/trusted.gpg.d/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
echo "deb [signed-by=/etc/apt/trusted.gpg.d/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt update
sudo apt install -y kubectl
----

. Verify virtualization features and install virtualization engine:
+
[source,console]
----
sudo apt install cpu-checker
kvm-ok
sudo apt-get install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager
----

. Install git: `sudo apt install git`.
. Download, install, and configure brew and then install helm and k9s:
+
[source, console]
----
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
(echo; echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"') >> /home/USERNAME/.profile
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
sudo apt-get install build-essential
brew install gcc helm derailed/k9s/k9s
----

. Download and install minikube:
+
[source, console]
----
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube_latest_amd64.deb
sudo dpkg -i minikube_latest_amd64.deb
----

. Add your user account to virtualization groups to be able to run virtualization commands without elevating permissions:
+
[source,console]
----
sudo adduser `id -un` libvirt
sudo adduser `id -un` kvm
----

. Edit the main configuration file for `libvirtd`:
`sudo vi /etc/libvirt/libvirtd.conf`.
. Set the UNIX domain socket group ownership to `libvirt` by uncommenting the following line: `unix_sock_group = "libvirt"`.
(In other words, remove the #.)

. Set the UNIX socket permissions for the R/W socket by uncommenting the following line and setting the correct permissions:
+
[source, console]
----
unix_sock_rw_perms = "0770"
sudo reboot
----

. To get the initial content downloaded for minikube:
+
[source, console]
----
minikube start
minikube stop
minikube delete
----

. Clone the `onms-k8s-poc repository`.
(Make sure your ssh key is set up at GitHub.)
+
[source, console]
----
git clone git@github.com:opennms-forge/onms-k8s-poc.git
----
+
OR
+
Download the zip at https://github.com/opennms-forge/onms-k8s-poc/archive/refs/heads/main.zip and unzip.

. Navigate to the `onms-k8s-poc` directory, start minikube with adequate resources, start Horizon through Helm, and then enable the ingress:
+
[source, console]
----

cd onms-k8s-poc/

minikube start --memory 6144 --cpus 4
ğŸ˜„  minikube v1.29.0 on Debian 11.6 (kvm/amd64)
âœ¨  Automatically selected the kvm2 driver. Other choices: qemu2, ssh
ğŸ‘  Starting control plane node minikube in cluster minikube
ğŸ”¥  Creating kvm2 VM (CPUs=4, Memory=6144MB, Disk=20000MB) ...
ğŸ³  Preparing Kubernetes v1.26.1 on Docker 20.10.23 ...
    â–ª Generating certificates and keys ...
    â–ª Booting up control plane ...
    â–ª Configuring RBAC rules ...
ğŸ”—  Configuring bridge CNI (Container Networking Interface) ...
    â–ª Using image gcr.io/k8s-minikube/storage-provisioner:v5
ğŸ”  Verifying Kubernetes components...
ğŸŒŸ  Enabled addons: storage-provisioner, default-storageclass
ğŸ„  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default

helm upgrade --install -f minimal-resources.yaml -f kill-it-with-fire.yaml -f minikube-host-postgresql.yaml -f bare-bones.yaml --set domain=domain.com donms ./opennms
Release "donms" does not exist. Installing it now.
NAME: donms
LAST DEPLOYED: Wed Mar 29 15:23:14 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
Thank you for installing OpenNMS 31.0.5.
----

**Notes**

Your release name `donms` is used for the following:

* Customer/deployment identifier.
* The namespace for all the resources.
* The subdomain for the ingress controller.
* The OpenNMS instance ID for your Minions (prefix for Kafka topics).
* Prefix for Elasticsearch indices.
* Prefix for PostgreSQL database names.
* Prefix for Kafka consumer groups.

Resources URLs:
OpenNMS Core: https://onms-core.donms.domain.com/opennms/login.jsp

To learn more about the release, try:

[source, console]
----
$ helm status donms
$ helm get all donms
$ kubectl get all -n donms
----

== minikube addons enable ingress
ğŸ’¡  ingress is an addon maintained by Kubernetes.
For any concerns, contact minikube on GitHub.

You can view the list of minikube maintainers at: https://github.com/kubernetes/minikube/blob/master/OWNERS
    â–ª Using image registry.k8s.io/ingress-nginx/controller:v1.5.1
    â–ª Using image registry.k8s.io/ingress-nginx/kube-webhook-certgen:v20220916-gd32f8c343
    â–ª Using image registry.k8s.io/ingress-nginx/kube-webhook-certgen:v20220916-gd32f8c343
ğŸ”  Verifying ingress addon...
ğŸŒŸ  The 'ingress' addon is enabled
